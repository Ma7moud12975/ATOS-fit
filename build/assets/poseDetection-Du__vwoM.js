class t{constructor(){this.pose=null,this.isInitialized=!1,this.perModeState={};this.perModeState.pushups={state:"up",count:0},this.perModeState.squats={state:"up",count:0},this.perModeState.lunges={state:"up",count:0},this.perModeState.burpees={state:"up",count:0},this.perModeState.situps={state:"neutral",count:0,_lastTorsoAngle:null,_situpState:"neutral",_lastSitupTime:0},this.perModeState.highknees={state:"down",count:0},this.perModeState.jumpingjacks={state:"down",count:0},this.perModeState.sideplank={state:"neutral",count:0,_stableCount:0,_lastHipY:null,_lastShoulderY:null,_lastAnkleY:null,_lastTimestamp:0},this.perModeState.plank={state:"neutral",count:0,_stableCount:0,_lastHipY:null,_lastShoulderY:null,_lastAnkleY:null,_lastTimestamp:0},this.postureStatus="unknown",this.lastWarningTime=0,this.videoDimensionsLogged=!1,this.exerciseMode="pushups",this.accumulatedCorrectMs=0,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onPushupCount=null,this.onPostureChange=null,this.onFormFeedback=null,this.onTimeUpdate=null}setExerciseMode(t){this.perModeState[this.exerciseMode]||(this.perModeState[this.exerciseMode]={state:"up",count:0});const e=String(t||"").toLowerCase();"plank"===e?this.exerciseMode="plank":"squats"===e||"squat"===e?this.exerciseMode="squats":"lunges"===e||"lunge"===e?this.exerciseMode="lunges":"burpees"===e||"burpee"===e?this.exerciseMode="burpees":e.includes("sit")||e.includes("situp")||e.includes("sit-ups")||e.includes("sit ups")?this.exerciseMode="situps":e.includes("high")&&e.includes("knees")?this.exerciseMode="highknees":e.includes("jumping")&&e.includes("jack")?this.exerciseMode="jumpingjacks":e.includes("side")&&e.includes("plank")?this.exerciseMode="sideplank":this.exerciseMode="pushups"}async initialize(){var t;try{if(!window.Pose){let t=0;for(;!window.Pose&&t<50;)await new Promise(t=>setTimeout(t,200)),t++;if(!window.Pose)return!1}this.pose=new window.Pose({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${t}`});const e=(null==(t=window.MediaPipeConfig)?void 0:t.POSE_CONFIG)||{modelComplexity:0,smoothLandmarks:!0,enableSegmentation:!1,smoothSegmentation:!1,minDetectionConfidence:.5,minTrackingConfidence:.5};return this.pose.setOptions(e),this.pose.onResults(this.onResults.bind(this)),this.isInitialized=!0,!0}catch(e){return!1}}async processFrame(t){var e;if(!this.isInitialized||!this.pose)return null;try{if(Math.random(),0===t.videoWidth||0===t.videoHeight)return void Math.random();this.videoDimensionsLogged||(this.videoDimensionsLogged=!0);const e=1920,s=1080;if(t.videoWidth>e||t.videoHeight>s)return;await this.pose.send({image:t})}catch(s){if(null==(e=s.message)?void 0:e.includes("memory access out of bounds"))return}}onResults(t){var e,s,i,n,o,a,u,l,r;if(this.lastResults=t,!t.poseLandmarks)return this.postureStatus="unknown",this.onPostureChange&&this.onPostureChange("unknown",null),void(this.timerRunning&&(this.accumulatedCorrectMs+=Date.now()-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3))));const h=t.poseLandmarks,c=this.checkBackAlignment(h);null==this._postureGoodCount&&(this._postureGoodCount=0),null==this._postureBadCount&&(this._postureBadCount=0),c?(this._postureGoodCount+=1,this._postureBadCount=0):(this._postureBadCount+=1,this._postureGoodCount=0);const d=(null==(s=null==(e=window.MediaPipeConfig)?void 0:e.SQUAT_CONFIG)?void 0:s.POSTURE_GOOD_FRAMES)??3,_="squats"===this.exerciseMode?(null==(n=null==(i=window.MediaPipeConfig)?void 0:i.SQUAT_CONFIG)?void 0:n.POSTURE_BAD_FRAMES)??6:(null==(a=null==(o=window.MediaPipeConfig)?void 0:o.SQUAT_CONFIG)?void 0:a.POSTURE_BAD_FRAMES)??4;let p=this.postureStatus;this._postureGoodCount>=d?p="correct":this._postureBadCount>=_&&(p="incorrect"),"squats"===this.exerciseMode&&(p="correct"),p!==this.postureStatus&&(this.postureStatus=p,this.onPostureChange&&this.onPostureChange(this.postureStatus,h));const S=(null==(u=window.MediaPipeConfig)?void 0:u.POSE_LANDMARKS)||{},M=h[S.LEFT_HIP||23],T=h[S.RIGHT_HIP||24],y=h[S.LEFT_KNEE||25],E=h[S.RIGHT_KNEE||26],m=M&&T?{x:(M.x+T.x)/2,y:(M.y+T.y)/2}:null,C=y&&E?{x:(y.x+E.x)/2,y:(y.y+E.y)/2}:null;if(m&&C&&(m.y,C.y),"correct"!==this.postureStatus&&!["highknees"].includes(this.exerciseMode)&&"squats"!==this.exerciseMode){const t=Date.now(),e=(null==(r=null==(l=window.MediaPipeConfig)?void 0:l.PLANK_CONFIG)?void 0:r.WARNING_COOLDOWN)||2e3;return t-this.lastWarningTime>e&&(this.playWarningSound(),this.lastWarningTime=t,this.onFormFeedback&&this.onFormFeedback({message:"Dangerous posture - straighten your back!",type:"warning",timestamp:t})),void("plank"!==this.exerciseMode&&"sideplank"!==this.exerciseMode||!this.timerRunning||(this.accumulatedCorrectMs+=t-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3))))}if("plank"===this.exerciseMode||"sideplank"===this.exerciseMode){const t=Date.now();if(this.isPlankStrictAndStable(h,t)){this.timerRunning||(this.startCorrectTimestampMs=t,this.timerRunning=!0);const e=this.accumulatedCorrectMs+(t-(this.startCorrectTimestampMs||t)),s=Math.floor(e/1e3);this.onTimeUpdate&&this.onTimeUpdate(s)}else this.timerRunning&&(this.accumulatedCorrectMs+=t-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3)));return}"squats"===this.exerciseMode?this.updateSquatCounter(h):"lunges"===this.exerciseMode?this.updateLungesCounter(h):"burpees"===this.exerciseMode?this.updateBurpeesCounter(h):"situps"===this.exerciseMode?this.updateSitUpsCounter(h):"highknees"===this.exerciseMode?this.updateHighKneesCounter(h):"jumpingjacks"===this.exerciseMode?this.updateJumpingJacksCounter(h):"sideplank"===this.exerciseMode?this.updateSidePlankCounter(h):this.updatePushupCounter(h)}calculateAngle(t,e,s){const i=Math.atan2(s.y-e.y,s.x-e.x)-Math.atan2(t.y-e.y,t.x-e.x);let n=Math.abs(180*i/Math.PI);return n>180&&(n=360-n),n}isPlankStrictAndStable(t,e){var s;try{const i=(null==(s=window.MediaPipeConfig)?void 0:s.PLANK_CONFIG)||{},n=i.LEFT_SHOULDER||11,o=i.RIGHT_SHOULDER||12,a=i.LEFT_HIP||23,u=i.RIGHT_HIP||24,l=i.LEFT_ANKLE||27,r=i.RIGHT_ANKLE||28,h=t[n],c=t[o],d=t[a],_=t[u],p=t[l],S=t[r],M=t=>t&&(null==t.visibility||t.visibility>.5),T=M(h)&&M(d),y=M(c)&&M(_);if(!T&&!y)return!1;let E=!1;const m=i.MIN_SIDE_ANGLE??155;if(M(h)&&M(d)&&M(p)){E=this.calculateAngle(h,d,p)>=m}else if(M(c)&&M(_)&&M(S)){E=this.calculateAngle(c,_,S)>=m}else{const t={x:(h.x+c.x)/2,y:(h.y+c.y)/2},e={x:(d.x+_.x)/2,y:(d.y+_.y)/2},s=t.x-e.x,n=t.y-e.y,o=Math.abs(180*Math.atan2(n,s)/Math.PI),a=i.HORIZ_MAX_DEG??30;E=o<=a||o>=180-a}if(!E)return!1;const C=this.perModeState[this.exerciseMode]||this.perModeState.plank,A=(d.y+_.y)/2,g=(h.y+c.y)/2,I=p&&S?(p.y+S.y)/2:null,R=i.MAX_DELTA_PER_SEC??.25,P=e||Date.now(),L=Math.max(1,P-(C._lastTimestamp||P));let N=null==C._lastHipY?0:Math.abs(A-C._lastHipY),w=null==C._lastShoulderY?0:Math.abs(g-C._lastShoulderY),H=null==I||null==C._lastAnkleY?0:Math.abs(I-C._lastAnkleY);const x=N*(1e3/L)>R||w*(1e3/L)>R||null!=I&&H*(1e3/L)>R;C._stableCount=x?0:(C._stableCount||0)+1,C._lastHipY=A,C._lastShoulderY=g,null!=I&&(C._lastAnkleY=I),C._lastTimestamp=P;const F=i.REQUIRED_STABLE_FRAMES??4,O=C._stableCount>=F;if(null!=I){const t=Math.abs(A-I);if(t<(i.MIN_HIP_ANKLE_DY??.06))return!1}return O}catch(i){return!1}}isPushupStartPose(t){var e,s,i;try{const n=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},o=t[n.LEFT_SHOULDER||11],a=t[n.RIGHT_SHOULDER||12],u=t[n.LEFT_HIP||23],l=t[n.RIGHT_HIP||24],r=t[n.LEFT_ANKLE||27],h=t[n.RIGHT_ANKLE||28],c=t=>t&&(null==t.visibility||t.visibility>.5);if(!(c(o)&&c(a)&&c(u)&&c(l)&&c(r)&&c(h)))return!1;const d=(o.y+a.y)/2,_=(u.y+l.y)/2,p=Math.abs(d-_);if(p>((null==(i=null==(s=window.MediaPipeConfig)?void 0:s.PUSHUP_CONFIG)?void 0:i.START_TORSO_DY)??.08))return!1;return!!((r.y+h.y)/2>_)}catch(n){return!1}}isSquatStartPose(t){var e,s,i,n,o,a,u;try{const l=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},r=t[l.LEFT_SHOULDER||11],h=t[l.RIGHT_SHOULDER||12],c=t[l.LEFT_HIP||23],d=t[l.RIGHT_HIP||24],_=t[l.LEFT_KNEE||25],p=t[l.RIGHT_KNEE||26],S=(t[l.LEFT_ANKLE||27],t[l.RIGHT_ANKLE||28],t=>t&&(null==t.visibility||t.visibility>.5));if(!(S(r)&&S(h)&&S(c)&&S(d)&&S(_)&&S(p)))return!1;const M=(c.y+d.y)/2,T=(_.y+p.y)/2;if(T-M<((null==(i=null==(s=window.MediaPipeConfig)?void 0:s.SQUAT_CONFIG)?void 0:i.START_HIP_KNEE_GAP)??.01))return!1;const y={x:(r.x+h.x)/2,y:(r.y+h.y)/2},E={x:(c.x+d.x)/2,y:(c.y+d.y)/2},m=y.x-E.x,C=y.y-E.y,A=Math.abs(180*Math.atan2(m,-C)/Math.PI),g=(null==(o=null==(n=window.MediaPipeConfig)?void 0:n.SQUAT_CONFIG)?void 0:o.STANDING_TORSO_MIN_DEG)??60,I=(null==(u=null==(a=window.MediaPipeConfig)?void 0:a.SQUAT_CONFIG)?void 0:u.STANDING_TORSO_MAX_DEG)??120;return!(A<g||A>I)}catch(l){return!1}}checkBackAlignment(t){var e,s,i,n;try{const o=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},a=t[o.LEFT_SHOULDER||11],u=t[o.RIGHT_SHOULDER||12],l=t[o.LEFT_HIP||23],r=t[o.RIGHT_HIP||24],h=t[o.LEFT_KNEE||25],c=t[o.RIGHT_KNEE||26],d=t[o.LEFT_ANKLE||27],_=t[o.RIGHT_ANKLE||28],p=t=>t&&(null==t.visibility||t.visibility>.5);if("plank"===this.exerciseMode){const t=p(a)&&p(l),e=p(u)&&p(r);if(!t&&!e)return!1}else if("pushups"===this.exerciseMode){if(!(p(a)&&p(u)&&p(l)&&p(r)))return!1}else if(!(p(a)&&p(u)&&p(l)&&p(r)&&p(h)&&p(c)))return!1;const S={x:(a.x+u.x)/2,y:(a.y+u.y)/2},M={x:(l.x+r.x)/2,y:(l.y+r.y)/2},T={x:(h.x+c.x)/2,y:(h.y+c.y)/2},y=p(d)&&p(_)?{x:(d.x+_.x)/2,y:(d.y+_.y)/2}:null,E=y||T,m={x:S.x-M.x,y:S.y-M.y},C=E?{x:E.x-M.x,y:E.y-M.y}:null;let A=!1;if("plank"===this.exerciseMode){const t=(null==(s=window.MediaPipeConfig)?void 0:s.PLANK_CONFIG)||{},e=p(a)&&p(l)&&p(d),i=p(u)&&p(r)&&p(_);if(e||i){const s=e?a:u,i=e?l:r,n=e?d:_,o=this.calculateAngle(s,i,n);if(A=o>=(t.MIN_SIDE_ANGLE??155),A&&y){const e=this.calculateAngle(l,h,d),s=this.calculateAngle(r,c,_),i=t.KNEE_MIN_DEG??150;A=A&&(e>=i&&s>=i)}}else{let e=-1;if(C){const t=Math.hypot(m.x,m.y)||1,s=Math.hypot(C.x,C.y)||1;e=(m.x*C.x+m.y*C.y)/(t*s)}const s=Math.abs(Math.max(-1,Math.min(1,e))),i=!!C&&s>=(t.STRAIGHT_ABS_COS_MIN??.9),n=S.x-M.x,o=S.y-M.y,a=Math.abs(180*Math.atan2(o,n)/Math.PI),u=t.HORIZ_MAX_DEG??35,p=a<=u||a>=180-u;let T=!0;if(y){const e=this.calculateAngle(l,h,d),s=this.calculateAngle(r,c,_),i=t.KNEE_MIN_DEG??150;T=e>=i&&s>=i}A=i&&p&&T}}else if("squats"===this.exerciseMode){const t=(null==(i=window.MediaPipeConfig)?void 0:i.SQUAT_CONFIG)||{},e=this.calculateAngle(a,l,h),s=(e+this.calculateAngle(u,r,c))/2,n=t.HIP_ANGLE_MIN??120,o=t.HIP_ANGLE_COLLAPSE??60,d=S.x-M.x,_=S.y-M.y,p=Math.abs(180*Math.atan2(d,-_)/Math.PI),y=t.TORSO_TILT_MAX??60,E=T&&M.y>T.y,m=t.COLLAPSE_TILT_MIN??70;A=!(s<o&&p>m)&&(!!E||s>=n&&p<=y)}else{const t=(null==(n=window.MediaPipeConfig)?void 0:n.PUSHUP_CONFIG)||{},e=t.SIDE_ABS_COS_MIN??.82,s=t.HORIZ_TORSO_MAX_DEG??35;if(y&&C){let t=-1;const s=Math.hypot(m.x,m.y)||1,i=Math.hypot(C.x,C.y)||1;t=(m.x*C.x+m.y*C.y)/(s*i);A=Math.abs(Math.max(-1,Math.min(1,t)))>=e}else{const t=S.x-M.x,e=S.y-M.y,i=Math.abs(180*Math.atan2(e,t)/Math.PI);A=(i<=s||i>=180-s)&&!(i>=70&&i<=110)}}return A}catch(o){return!1}}updatePushupCounter(t){var e,s,i,n,o,a;try{const u=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},l=(null==(s=window.MediaPipeConfig)?void 0:s.PUSHUP_CONFIG)||{},r=t[u.LEFT_SHOULDER||11],h=t[u.LEFT_ELBOW||13],c=t[u.LEFT_WRIST||15],d=t[u.RIGHT_SHOULDER||12],_=t[u.RIGHT_ELBOW||14],p=t[u.RIGHT_WRIST||16],S=t[u.LEFT_HIP||23],M=t[u.RIGHT_HIP||24];if(!(r&&h&&c&&d&&_&&p&&S&&M))return;const T=this.calculateAngle(r,h,c),y=(T+this.calculateAngle(d,_,p))/2,E=(r.y+d.y)/2,m=l.ELBOW_ANGLE_DOWN||95,C=l.ELBOW_ANGLE_UP||155,A=l.SHOULDER_HEIGHT_DOWN||.02,g=Math.abs((r.y+d.y)/2-(S.y+M.y)/2),I=(l.TORSO_VERTICAL_DY,!(g<(l.STANDING_DY_MIN??.05))&&(r.y+d.y)/2<(S.y+M.y)/2-(l.STANDING_DY_MIN??.02)),R=this.perModeState.pushups;R._baselineShoulderY||(R._baselineShoulderY=E),Math.abs((r.y+d.y)/2-(S.y+M.y)/2)<.12&&(R._baselineShoulderY=.95*R._baselineShoulderY+.05*E);const P=E-(R._baselineShoulderY||E),L=l.SHOULDER_DROP_THRESHOLD??.06,N=y<=m||P>=L||E>=1-A,w=y>=C&&I;R._inPositionCount||(R._inPositionCount=0);this.isPushupStartPose(t)?R._inPositionCount+=1:R._inPositionCount=0;const H=(null==(n=null==(i=window.MediaPipeConfig)?void 0:i.PUSHUP_CONFIG)?void 0:n.START_STABLE_FRAMES)??6;R._isInStartPose=R._inPositionCount>=H;const x=(null==(a=null==(o=window.MediaPipeConfig)?void 0:o.PUSHUP_CONFIG)?void 0:a.MIN_REP_MS)??400;R._lastRepAt||(R._lastRepAt=0);const F=Date.now();if("correct"!==this.postureStatus||!R._isInStartPose)return;"up"===R.state?N&&F-R._lastRepAt>x&&(R.state="down",R.count+=1,R._lastRepAt=F,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(R.count),this.onFormFeedback&&this.onFormFeedback({message:`Push-up ${R.count}`,type:"success",timestamp:F})):"down"===R.state&&(w||!N&&y>=C)&&(R.state="up")}catch(u){}}updateSquatCounter(t){var e,s,i,n;try{const o=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},a=(null==(s=window.MediaPipeConfig)||s.SQUAT_CONFIG,t[o.LEFT_HIP||23]),u=t[o.RIGHT_HIP||24],l=t[o.LEFT_KNEE||25],r=t[o.RIGHT_KNEE||26],h=t[o.LEFT_ANKLE||27],c=t[o.RIGHT_ANKLE||28],d=t[o.LEFT_SHOULDER||11],_=t[o.RIGHT_SHOULDER||12];if(!(a&&u&&l&&r&&h&&c&&d&&_))return;const p=(d.y+_.y)/2,S=(a.y+u.y)/2,M=t[o.NOSE||0],T=Math.abs(p-S),y=.08,E=Math.abs(((null==M?void 0:M.y)??0)-S);let m=!1;T<=y&&E<=.1&&(m=!0,this.onFormFeedback&&this.onFormFeedback({message:"وضع الجسم أفقي، لن يتم العد إلا في وضع الاسكوات الصحيح",type:"warning",timestamp:Date.now()}));const C=t[o.LEFT_WRIST||15],A=t[o.RIGHT_WRIST||16],g=t[o.LEFT_ANKLE||27],I=t[o.RIGHT_ANKLE||28],R=.07;let P=!1;if(C&&A&&g&&I){const t=(C.y+A.y)/2;t>=(g.y+I.y)/2-R&&(P=!0,this.onFormFeedback&&this.onFormFeedback({message:"اليدين على الأرض، لن يتم العد إلا في وضع الاسكوات الصحيح",type:"warning",timestamp:Date.now()}))}const L={x:(a.x+u.x)/2,y:(a.y+u.y)/2},N={x:(l.x+r.x)/2,y:(l.y+r.y)/2},w=(h.x,c.x,h.y,c.y,d.x,_.x,d.y,_.y,this.calculateAngle(a,l,h)),H=(this.calculateAngle(u,r,c),l.y),x=r.y,F=Math.abs(H-x),O=F<=.05,b=L.y,G=N.y,D=b>G,f=b<G,v=this.perModeState.squats,k=(null==(n=null==(i=window.MediaPipeConfig)?void 0:i.SQUAT_CONFIG)?void 0:n.MIN_REP_MS)??500;v._lastRepAt||(v._lastRepAt=0);const U=Date.now();"up"===v.state?D&&O&&!m&&!P&&U-v._lastRepAt>k?(v.state="down",v.count+=1,v._lastRepAt=U,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(v.count)):D&&O&&(m||P||v._lastRepAt):"down"===v.state&&f&&(v.state="up")}catch(o){}}updateLungesCounter(t){var e,s;try{const i=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},n=(null==(s=window.MediaPipeConfig)||s.LUNGES_CONFIG,t[i.LEFT_HIP||23]),o=t[i.RIGHT_HIP||24],a=t[i.LEFT_KNEE||25],u=t[i.RIGHT_KNEE||26],l=t[i.LEFT_ANKLE||27],r=t[i.RIGHT_ANKLE||28];if(!(n&&o&&a&&u&&l&&r))return;const h=t[i.LEFT_WRIST||15],c=t[i.RIGHT_WRIST||16],d=t[i.LEFT_ANKLE||27],_=t[i.RIGHT_ANKLE||28],p=.07;let S=!1;if(h&&c&&d&&_){const t=(h.y+c.y)/2;t>=(d.y+_.y)/2-p&&(S=!0)}const M={x:(n.x+o.x)/2,y:(n.y+o.y)/2},T=this.calculateAngle(n,a,l),y=this.calculateAngle(o,u,r),E=T<y,m=E?a:u,C=E?T:y,A=E?y:T,g=y<T,I=g?y:T,R=g?T:y,P=(M.y,m.y,.06),L=120,N=100,w=.08,H=Math.abs(a.y-u.y)>P,x=A<L,F=C<N,O=E?n:o,b=E?l:r,G=Math.abs(O.x-b.x)<w,D=H&&x&&F&&G,f=R<L,v=I<N,k=g?o:n,U=g?r:l,K=Math.abs(k.x-U.x)<w,W=D||H&&f&&v&&K,B=C>=160&&A>=150,Y=this.perModeState.lunges;"up"===Y.state?!S&&W&&(Y.state="down",Y.count+=1,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(Y.count),this.onFormFeedback&&this.onFormFeedback({message:`Lunge ${Y.count}`,type:"success",timestamp:Date.now()})):"down"===Y.state&&B&&(Y.state="up")}catch(i){}}updateSitUpsCounter(t){var e,s,i,n,o,a,u;try{const l=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},r=t[l.LEFT_SHOULDER||11],h=t[l.RIGHT_SHOULDER||12],c=t[l.LEFT_HIP||23],d=t[l.RIGHT_HIP||24],_=t[l.LEFT_KNEE||25],p=t[l.RIGHT_KNEE||26];if(!(r&&h&&c&&d&&_&&p))return;const S={x:(r.x+h.x)/2,y:(r.y+h.y)/2},M={x:(c.x+d.x)/2,y:(c.y+d.y)/2},T={x:(_.x+p.x)/2,y:(_.y+p.y)/2},y=this.calculateAngle(S,M,T),E=this.perModeState.situps;E._lastTorsoAngle||(E._lastTorsoAngle=y),E._situpState||(E._situpState="down"),E._lastSitupTime||(E._lastSitupTime=0);const m=Date.now(),C=(null==(i=null==(s=window.MediaPipeConfig)?void 0:s.SITUP_CONFIG)?void 0:i.MIN_REP_MS)||600,A=(null==(o=null==(n=window.MediaPipeConfig)?void 0:n.SITUP_CONFIG)?void 0:o.ANGLE_DOWN)??120,g=(null==(u=null==(a=window.MediaPipeConfig)?void 0:a.SITUP_CONFIG)?void 0:u.ANGLE_UP)??100;"down"===E._situpState?y<g&&m-E._lastSitupTime>C&&(E._situpState="up",E._lastSitupTime=m):"up"===E._situpState&&y>A&&m-E._lastSitupTime>C&&(E._situpState="down",E.count+=1,E._lastSitupTime=m,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(E.count),this.onFormFeedback&&this.onFormFeedback({message:`Sit-up ${E.count}`,type:"success",timestamp:m})),E._lastTorsoAngle=y,Math.abs(c.y-d.y)>.08&&this.onFormFeedback&&Math.random()<.08&&this.onFormFeedback({message:"Keep hips level during sit-ups",type:"warning",timestamp:m})}catch(l){}}updateBurpeesCounter(t){var e;try{const s=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},i=t[s.NOSE||0],n=t[s.LEFT_WRIST||15],o=t[s.RIGHT_WRIST||16],a=t[s.LEFT_INDEX||19],u=t[s.RIGHT_INDEX||20];if(!i||!n||!o)return;const l=i.y,r=a?a.y:n.y,h=u?u.y:o.y,c=r<l&&h<l;this._burpeeState||(this._burpeeState="ready"),this.perModeState.burpees._burpeeState||(this.perModeState.burpees._burpeeState="ready");const d=this.perModeState.burpees;"ready"===d._burpeeState?c&&(d._burpeeState="jumping",d.count+=1,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(d.count),this.onFormFeedback&&this.onFormFeedback({message:`Burpee ${d.count} - Hands above head!`,type:"success",timestamp:Date.now()})):"jumping"===d._burpeeState&&(c||(d._burpeeState="ready"))}catch(s){}}updateHighKneesCounter(t){var e;try{const s=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},i=t[s.LEFT_HIP||23],n=t[s.RIGHT_HIP||24],o=t[s.LEFT_KNEE||25],a=t[s.RIGHT_KNEE||26],u=t[s.LEFT_ANKLE||27],l=t[s.RIGHT_ANKLE||28];if(!(i&&n&&o&&a&&u&&l))return;const r=.03,h=i.y-o.y>r,c=n.y-a.y>r,d=h||c,_=this.perModeState.highknees;_._highKneesState||(_._highKneesState="stopped"),_._startTime||(_._startTime=0),_._lastUpdateTime||(_._lastUpdateTime=0);const p=Date.now();if("stopped"===_._highKneesState)d&&(_._highKneesState="active",_._startTime=p,_._lastUpdateTime=p,_.count=0);else if("active"===_._highKneesState)if(d){_._lastUpdateTime=p;const t=Math.floor((p-_._startTime)/1e3);t>_.count&&(_.count=t,this.onPushupCount&&this.onPushupCount(_.count))}else{p-_._lastUpdateTime>1500&&(_._highKneesState="stopped")}}catch(s){}}updateJumpingJacksCounter(t){var e,s;try{const i=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},n=(null==(s=window.MediaPipeConfig)?void 0:s.JUMPINGJACKS_CONFIG)||{},o=t[i.LEFT_SHOULDER||11],a=t[i.RIGHT_SHOULDER||12],u=t[i.LEFT_HIP||23],l=t[i.RIGHT_HIP||24],r=t[i.LEFT_KNEE||25],h=t[i.RIGHT_KNEE||26],c=t[i.LEFT_ELBOW||13],d=t[i.RIGHT_ELBOW||14],_=t[i.LEFT_WRIST||15],p=t[i.RIGHT_WRIST||16],S=t[i.LEFT_ANKLE||27],M=t[i.RIGHT_ANKLE||28];if(!(o&&a&&u&&l&&r&&h&&c&&d&&_&&p&&S&&M))return;const T=this.calculateAngle(c,o,_),y=this.calculateAngle(d,a,p),E=this.calculateAngle(r,u,S),m=this.calculateAngle(h,l,M),C=(this.calculateAngle(u,r,S),this.calculateAngle(l,h,M),n.SHOULDER_ABDUCTION_DOWN||40),A=n.SHOULDER_ABDUCTION_UP||145,g=n.HIP_ABDUCTION_DOWN||12,I=n.HIP_ABDUCTION_UP||32,R=n.MIN_REP_MS||800,P=n.UP_FRAMES||2,L=n.DOWN_FRAMES||3,N=n.ANKLE_SCALE||1.1,w=n.MIN_UP_MS||200,H=this.perModeState.jumpingjacks;H._lastRepAt||(H._lastRepAt=0),H._upCount||(H._upCount=0),H._downCount||(H._downCount=0),H._baselineAnkleDist||(H._baselineAnkleDist=null),H._upSince||(H._upSince=0),H._history||(H._history=[]);const x=n.HISTORY_MAX||5,F=Date.now(),O=t=>t&&(null==t.visibility||t.visibility>.5),b=(T+y)/2,G=(E+m)/2,D=(_.y+p.y)/2,f=(o.y+a.y)/2,v=Math.abs(S.x-M.x),k=Math.abs(u.x-l.x),U=Math.abs(o.x-a.x)||1e-4,K=Math.abs((o.y+a.y)/2-(u.y+l.y)/2)||1e-4,W=v/U,B=k/U,Y=(f-D)/K||0;H._history.push({sa:b,ha:G,nad:W,nhd:B,wan:Y}),H._history.length>x&&H._history.shift();const j={sa:0,ha:0,nad:0,nhd:0,wan:0};H._history.forEach(t=>{j.sa+=t.sa,j.ha+=t.ha,j.nad+=t.nad,j.nhd+=t.nhd,j.wan+=t.wan});const q=H._history.length||1,X=j.sa/q,Q=j.ha/q,J=j.nad/q,$=j.nhd/q,z=j.wan/q;"down"===H.state&&null==H._baselineAnkleDist&&v>0&&k>0&&(H._baselineAnkleDist=Math.max(k,.9*v));O(_)&&O(p),Math.max((H._baselineAnkleDist?H._baselineAnkleDist/U:B)*N,B*N);const V=X>A,Z=Q>I,tt=O(_)&&O(p)&&z>.16,et=J>Math.max((H._baselineAnkleDist?H._baselineAnkleDist/U:$)*N,$*N),st=tt&&et||V&&Z||tt&&Z||V&&et,it=b<C,nt=J<(H._baselineAnkleDist||k)/U*(N-.05),ot=it&&nt||X<C&&Q<g;if((H._debugCounter||0)%30==0?H._debugCounter=0:H._debugCounter=(H._debugCounter||0)+1,H._ignoreUntil||(H._ignoreUntil=0),"down"===H.state)st?(F>=H._ignoreUntil&&(H._upCount+=1),H._upSince||(H._upSince=F)):(H._upCount=0,H._upSince=0),H._upCount>=P&&F-(H._lastStateChange||0)>120&&(H.state="up",H._lastStateChange=F,H._upCount=0,H._upSince=H._upSince||F),F-(H._lastStateChange||0)>6e3&&(H._baselineAnkleDist=Math.max(k,.9*v));else if("up"===H.state){const t=H._upSince?F-H._upSince:0;ot?H._downCount+=1:H._downCount=0,H._downCount>=L&&t>=w&&F-H._lastRepAt>R&&(H.state="down",H.count+=1,H._lastRepAt=F,H._lastStateChange=F,H._downCount=0,H._upSince=0,H._ignoreUntil=F+Math.min(600,Math.floor(R/2)),H._baselineAnkleDist=Math.max(k,.9*v),this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(H.count),this.onFormFeedback&&this.onFormFeedback({message:`Jumping Jack ${H.count}`,type:"success",timestamp:F}))}}catch(i){}}updateSidePlankCounter(t){var e,s;try{const i=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},n=(null==(s=window.MediaPipeConfig)?void 0:s.SIDEPLANK_CONFIG)||{},o=t[i.LEFT_SHOULDER||11],a=t[i.RIGHT_SHOULDER||12],u=t[i.LEFT_ELBOW||13],l=t[i.RIGHT_ELBOW||14],r=t[i.LEFT_WRIST||15],h=t[i.RIGHT_WRIST||16],c=t[i.LEFT_HIP||23],d=t[i.RIGHT_HIP||24],_=t[i.LEFT_KNEE||25],p=t[i.RIGHT_KNEE||26],S=t[i.LEFT_ANKLE||27],M=t[i.RIGHT_ANKLE||28],T=(t[i.NOSE||0],t[i.LEFT_EAR||7]),y=t[i.RIGHT_EAR||8],E=t=>t&&(null==t.visibility||t.visibility>.5),m=E(o)&&E(u)&&E(c)&&E(_)&&E(S),C=E(a)&&E(l)&&E(d)&&E(p)&&E(M);if(!m&&!C)return;const A=m&&(!C||m),g=A?o:a,I=A?u:l,R=A?r:h,P=A?c:d,L=A?S:M,N=A?T:y,w=this.calculateAngle(g,I,R),H=n.SHOULDER_ANGLE_MIN||80,x=n.SHOULDER_ANGLE_MAX||100,F=w>=H&&w<=x,O=this.calculateAngle(g,P,L),b=n.TORSO_ANGLE_MIN||160,G=n.TORSO_ANGLE_MAX||200,D=O>=b&&O<=G,f=(g.y+L.y)/2,v=n.HIP_SAG_THRESHOLD||.05,k=P.y>f+v,U=n.HIP_HIKE_THRESHOLD||.05,K=P.y<f-U,W=n.ELBOW_ALIGNMENT_THRESHOLD||.08,B=Math.abs(I.x-g.x)<W,Y=n.FEET_STACKING_THRESHOLD||.1,j=Math.abs(S.x-M.x)<Y;let q=!0;if(N&&E(N)){const t=this.calculateAngle(N,g,P),e=n.HEAD_NECK_ANGLE_MIN||160,s=n.HEAD_NECK_ANGLE_MAX||200;q=t>=e&&t<=s}const X=F&&D&&!k&&!K&&B&&j&&q;X?(this._postureGoodCount=(this._postureGoodCount||0)+1,this._postureBadCount=0):(this._postureBadCount=(this._postureBadCount||0)+1,this._postureGoodCount=0);const Q=n.POSTURE_GOOD_FRAMES||3,J=n.POSTURE_BAD_FRAMES||4;let $=this.postureStatus;if(this._postureGoodCount>=Q?$="correct":this._postureBadCount>=J&&($="incorrect"),$!==this.postureStatus&&(this.postureStatus=$,this.onPostureChange&&this.onPostureChange(this.postureStatus,t)),"correct"===this.postureStatus){const t=Date.now();this.timerRunning||(this.startCorrectTimestampMs=t,this.timerRunning=!0);const e=this.accumulatedCorrectMs+(t-(this.startCorrectTimestampMs||t)),s=Math.floor(e/1e3);this.onTimeUpdate&&this.onTimeUpdate(s)}else this.timerRunning&&(this.accumulatedCorrectMs+=Date.now()-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3)));if(!X&&this.onFormFeedback){const t=Date.now(),e=n.WARNING_COOLDOWN||2e3;if(t-this.lastWarningTime>e){let e="";k?e="Hip sagging - lift your hips up!":K?e="Hip too high - lower your hips!":B?j?F?D||(e="Keep your body straight!"):e="Adjust your arm position!":e="Stack your feet together!":e="Keep elbow under shoulder!",e&&(this.onFormFeedback({message:e,type:"warning",timestamp:t}),this.lastWarningTime=t)}}}catch(i){}}playWarningSound(){try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),s=t.createGain();e.connect(s),s.connect(t.destination),e.frequency.setValueAtTime(800,t.currentTime),e.type="sine",s.gain.setValueAtTime(0,t.currentTime),s.gain.linearRampToValueAtTime(.3,t.currentTime+.1),s.gain.exponentialRampToValueAtTime(.01,t.currentTime+.5),e.start(t.currentTime),e.stop(t.currentTime+.5)}catch(t){}}playSuccessSound(){try{const t=new Audio("/assets/sounds/pop.wav");t.volume=.5,t.play().catch(t=>{})}catch(t){}}drawPoseOverlay(t,e,s,i){if(Math.random(),!e.poseLandmarks||!t)return;t.save(),t.clearRect(0,0,s,i);const n=e.poseLandmarks;n.forEach((e,n)=>{if(e.visibility&&e.visibility>.5){const n=e.x*s,o=e.y*i;t.beginPath(),t.arc(n,o,6,0,2*Math.PI),t.fillStyle=e.visibility>.7?"#10B981":"#F59E0B",t.fill(),t.strokeStyle="#FFFFFF",t.lineWidth=2,t.stroke()}}),Math.random(),this.drawBasicConnections(t,n,s,i),t.restore()}drawBasicConnections(t,e,s,i){[[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]].forEach(([n,o])=>{const a=e[n],u=e[o];a&&u&&a.visibility>.5&&u.visibility>.5&&(t.beginPath(),t.moveTo(a.x*s,a.y*i),t.lineTo(u.x*s,u.y*i),t.strokeStyle="#3B82F6",t.lineWidth=3,t.stroke())}),Math.random()}resetCounter(){const t=this.exerciseMode;this.perModeState&&this.perModeState[t]&&(this.perModeState[t].count=0,this.perModeState[t].state="up","situps"===t&&(this.perModeState[t]._lastTorsoAngle=null,this.perModeState[t]._situpState="down",this.perModeState[t]._lastSitupTime=0),"burpees"===t&&(this.perModeState[t]._burpeeState="ready"),"jumpingjacks"===t&&(this.perModeState[t]._lastRepAt=0),"sideplank"===t&&(this.perModeState[t].state="neutral",this.perModeState[t].count=0),"plank"===t&&(this.perModeState[t]._stableCount=0,this.perModeState[t]._lastHipY=null,this.perModeState[t]._lastShoulderY=null,this.perModeState[t]._lastAnkleY=null,this.perModeState[t]._lastTimestamp=0)),this.postureStatus="unknown",this.accumulatedCorrectMs=0,this.timerRunning=!1,this.startCorrectTimestampMs=0}getStats(){const t=this.exerciseMode,e=this.perModeState&&this.perModeState[t]?this.perModeState[t]:{count:0,state:"up"};return{count:e.count||0,state:e.state||"up",posture:this.postureStatus,timeSec:Math.floor((this.accumulatedCorrectMs+(this.timerRunning?Date.now()-this.startCorrectTimestampMs:0))/1e3)}}getLastResults(){return this.lastResults}setCallbacks({onPushupCount:t,onPostureChange:e,onFormFeedback:s,onTimeUpdate:i}){this.onPushupCount=t,this.onPostureChange=e,this.onFormFeedback=s,this.onTimeUpdate=i}cleanup(){this.pose&&(this.pose.close(),this.pose=null),this.isInitialized=!1}}export{t as default};
//# sourceMappingURL=poseDetection-Du__vwoM.js.map
